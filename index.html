<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>the-future.sh</title>
    
    <!-- Libraries and Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/typed.js@2.1.0/dist/typed.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG4dGzcSTjpTJpe1pQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* --- Global Styles --- */
        :root {
            --background-color: #0d1117;
            --text-color: #c9d1d9;
            --prompt-color: #58a6ff;
            --accent-color: #56d364;
            --error-color: #f85149;
            --font-family: 'Roboto Mono', 'SF Mono', 'Courier New', monospace;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: var(--font-family);
            font-size: 16px;
            line-height: 1.6;
        }

        #header-container {
            padding: 20px 20px 0 20px;
            box-sizing: border-box;
        }

        #terminal {
            padding: 20px;
            box-sizing: border-box;
            height: calc(100% - 40px);
            overflow-y: auto;
            cursor: text;
        }

        .line {
            white-space: pre-wrap;
            word-break: break-all;
            min-height: 1.6em;
        }

        .prompt {
            color: var(--prompt-color);
            margin-right: 0.5em;
        }
        
        .command-input-container {
            display: flex;
            flex-grow: 1;
        }

        .terminal-input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-color);
            font-family: inherit;
            font-size: inherit;
            caret-color: var(--accent-color);
            flex-grow: 1;
            padding: 0;
        }

        .log-fatal { color: var(--error-color); }
        .log-info { color: var(--prompt-color); font-weight: bold; }
        .log-ok { color: var(--accent-color); }
        .log-tip { color: #8b949e; }

        #share-container {
            display: none;
            padding: 15px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background-color: #161b22;
            margin-bottom: 20px;
        }

        #share-container img {
            max-width: 100%;
            border-radius: 6px;
            border: 1px solid #30363d;
            margin-top: 10px;
        }

        .share-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .share-button {
            background-color: var(--accent-color);
            color: var(--background-color);
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: opacity 0.2s;
        }
        .share-button:hover {
            opacity: 0.8;
        }
        
        .share-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .share-button[title] {
            position: relative;
        }
        
        .share-button[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            margin-bottom: 5px;
            pointer-events: none;
            opacity: 0;
            animation: tooltipFade 0.2s ease-in-out forwards;
        }
        
        @keyframes tooltipFade {
            to {
                opacity: 1;
            }
        }
        
        /* Social media specific colors */
        .share-twitter {
            background-color: #1DA1F2;
        }
        .share-facebook {
            background-color: #1877F2;
        }
        .share-linkedin {
            background-color: #0A66C2;
        }
        
        /* Intro animation styles */
        .typing-cursor {
            display: inline-block;
            width: 0.6em;
            height: 1.2em;
            background-color: var(--accent-color);
            animation: cursor-blink 1s infinite;
            vertical-align: text-bottom;
            margin-left: 2px;
        }
        
        @keyframes cursor-blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }
        
        .intro-line {
            pointer-events: none;
        }
        
        .command-execute {
            animation: execute-flash 0.3s ease-out;
        }
        
        @keyframes execute-flash {
            0% { background-color: transparent; }
            50% { background-color: rgba(88, 166, 255, 0.1); }
            100% { background-color: transparent; }
        }
        
        .share-prompt {
            margin-top: 1em;
            margin-bottom: 1em;
        }
        
        .share-option {
            padding-left: 2em;
            position: relative;
            color: #c1c1c1;
        }
        
        .share-option.selected {
            color: var(--accent-color);
        }
        
        .share-option.selected::before {
            content: '>';
            position: absolute;
            left: 0.5em;
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <div id="terminal">
        <!-- JavaScript will populate content here -->
    </div>

    <script>
        // --- DOM Elements & Settings ---
        const headerContainer = document.getElementById('header-container');
        const terminal = document.getElementById('terminal');
        let currentInput = null;
        const commandHistory = [];
        let historyIndex = -1;
        
        // Share prompt state management
        let sharePromptActive = false;
        let sharePromptSelection = 1; // 1 for Yes, 2 for No
        let lastBootedFuture = null; // Store last boot data
        let shareTimeoutId = null; // Timeout reference
        
        // Interactive mode state
        let interactiveMode = false;
        let interactiveStep = null;
        let interactiveVision = '';
        let interactiveCommit = '';
        
        // Interactive confirm prompt state
        let interactiveConfirmActive = false;
        let interactiveConfirmSelection = 1; // 1 for Yes, 2 for No
        
        // Error tracking for guide hint
        let consecutiveErrors = 0;
        
        let currentLanguage = 'en'; // default to English
        
        // Language detection function
        function detectUserLanguage() {
            // 1. Check URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            if (urlLang === 'ja' || urlLang === 'en') {
                return urlLang;
            }
            
            // 2. Check localStorage
            const storedLang = localStorage.getItem('preferredLanguage');
            if (storedLang === 'ja' || storedLang === 'en') {
                return storedLang;
            }
            
            // 3. Check browser language
            const browserLang = navigator.language || navigator.languages[0];
            if (browserLang.startsWith('ja')) {
                return 'ja';
            }
            
            // 4. Default to English
            return 'en';
        }
        
        // File system structure
        const fileSystem = {
            'README.md': {
                content: [
                    '# the-future.sh',
                    '',
                    'A tiny CLI simulator to boot your future.',
                    '',
                    'Run ./future.sh --vision "your vision" --commit "your action"'
                ]
            },
            'vision.txt': {
                content: ['Your vision awaits. Use ./future.sh to define it.']
            },
            'future.sh': {
                content: null, // Special handling - cannot be displayed
                protected: true
            }
        };
        
        // Available files for ls and tab completion
        const availableFiles = Object.keys(fileSystem);
        
        // i18n translations
        const i18n = {
            en: {
                fatal: '[FATAL] Core components missing. Future cannot be initialized.',
                requiredFlags: '        Required flags: --vision, --commit',
                usage: 'USAGE:',
                usageExample: '  ./future.sh --vision "a world where..." --commit "what you will do now"',
                tip: '# Tip: A vision without a commit is just a dream.',
                interactiveWelcome: '[INTERACTIVE MODE] Welcome to the guided future boot process!',
                interactiveIntro: 'This mode will help you craft your vision and commitment step by step.',
                interactiveVisionPrompt: 'What is your vision for the future? (Type your answer and press Enter)',
                interactiveVisionExample: '# Example: "a world where everyone has access to education"',
                visionRecorded: 'Vision recorded',
                interactiveCommitPrompt: 'Now, what is the first concrete action you will take to make this vision real?',
                interactiveCommitExample: '# Example: "sign up for an online course today"',
                commitRecorded: 'First commit recorded',
                interactiveConfirmPrompt: 'Here\'s the command that will boot your future:',
                interactiveConfirm: 'Ready to execute? Type "yes" to proceed or "no" to cancel.',
                interactiveCancelled: 'Interactive mode cancelled. You can try again anytime.',
                executing: 'Executing command...',
                initializing: 'Initializing future with new parameters...',
                visionLocked: 'Vision locked',
                commitRegistered: 'First commit registered',
                bootComplete: 'Boot sequence complete.',
                processStarted: 'Future process started successfully.',
                daemonizing: 'Daemonizing... Your future is now running in the background. Keep committing.',
                generating: 'Generating a shareable snapshot...',
                shareText: 'Your future has been initiated! Share this moment.',
                downloadButton: 'Download Image',
                shareButton: 'Share on X',
                shareFacebook: 'Share on Facebook',
                shareLinkedin: 'Share on LinkedIn',
                commandNotFound: 'command not found',
                helpUsage: 'Usage: ./future.sh --vision "<vision>" --commit "<action>"',
                helpDescription: 'Boot your future by declaring your vision and committing to action.',
                helpOptions: 'Options:',
                helpVision: '  --vision "<text>"     Your vision for the future (required)',
                helpCommit: '  --commit "<text>"     Your first concrete action (required)',
                helpInteractive: '  --interactive         Start guided mode for beginners',
                helpHelp: '  --help                Show this help message',
                helpWhen: '  --when "<date>"       Deadline for starting (optional)',
                helpFirstStep: '  --first-step "<text>" The very first micro-action (optional)',
                helpWhy: '  --why "<text>"        Personal motivation (optional)',
                helpMilestone: '  --milestone "<text>"  Intermediate goal (optional)',
                helpExamples: 'Examples:',
                helpExample1: '  ./future.sh --vision "a world of clean energy" --commit "install solar panels"',
                helpExample2: '  ./future.sh --interactive',
                helpExample3: '  ./future.sh --vision "create a world where anyone can swim anywhere" --commit "dig up neighbor\'s yard" \\',
                helpExample4: '    --first-step "sneak into neighbor\'s property" --milestone "dig 25 meters" \\',
                helpExample5: '    --why "having a pool next door would be lovely" --when "2025-07-07"',
                availableCommands: 'Available commands:',
                cmdBootFuture: '  ./future.sh --vision "<vision>" --commit "<action>"  - Boot your future',
                cmdInteractive: '  ./future.sh --interactive                            - Guided mode',
                cmdHelp: '  ./future.sh --help                                   - Show help',
                cmdLs: '  ls                                                        - List files',
                cmdCat: '  cat <file>                                                - Display file contents',
                cmdClear: '  clear                                                     - Clear terminal',
                cmdPwd: '  pwd                                                       - Print working directory',
                cmdWhoami: '  whoami                                                    - Display current user',
                cmdHelpCmd: '  help                                                      - Show this help message',
                firstCheckpoint: 'First checkpoint',
                milestone: 'Milestone',
                drivenBy: 'Driven by',
                deadline: 'Deadline',
                sharePrompt: 'Would you like to share your future with others?',
                shareYes: 'Yes',
                shareNo: 'No',
                shareDeclined: 'Understood. Your future is already running.\nKeep committing!',
                shareTimeout: 'Auto-selected: No (timeout)',
                shareLastNoData: 'No future to share. Boot your future first with ./future.sh',
                shareLastPrompt: 'Share your last booted future?',
                newUserHint: "New here? Type 'guide' for beginner-friendly mode!",
                copyButton: 'Copy to Clipboard',
                copySuccess: 'Copied!',
                copyFailed: 'Failed to copy. Please try right-click the image itself instead.',
                copyTooltip: 'Right-click the image itself to save it'
            },
            ja: {
                fatal: '[è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼] ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚æœªæ¥ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã€‚',
                requiredFlags: '        å¿…é ˆãƒ•ãƒ©ã‚°: --vision, --commit',
                usage: 'ä½¿ç”¨æ–¹æ³•:',
                usageExample: '  ./future.sh --vision "ã€œãªä¸–ç•Œ" --commit "ä»Šã™ãã‚„ã‚‹ã“ã¨"',
                tip: '# ãƒ’ãƒ³ãƒˆ: æœªæ¥ã‚’èªã‚‹ã«ã¯ãƒ“ã‚¸ãƒ§ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒ“ã‚¸ãƒ§ãƒ³ã‚’å¤¢ã§çµ‚ã‚ã‚‰ã›ãªã„ãŸã‚ã«ã¯ã‚³ãƒŸãƒƒãƒˆãŒå¿…è¦ã§ã™ã€‚',
                interactiveWelcome: '[å¯¾è©±ãƒ¢ãƒ¼ãƒ‰] æœªæ¥èµ·å‹•ãƒ—ãƒ­ã‚»ã‚¹ã¸ã‚ˆã†ã“ãï¼',
                interactiveIntro: 'ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ãƒ“ã‚¸ãƒ§ãƒ³ã¨ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆã‚’æ®µéšçš„ã«ä½œæˆã§ãã¾ã™ã€‚',
                interactiveVisionPrompt: 'ã‚ãªãŸã®æœªæ¥ã®ãƒ“ã‚¸ãƒ§ãƒ³ã¯ä½•ã§ã™ã‹ï¼Ÿï¼ˆå…¥åŠ›ã—ã¦Enterã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰',
                interactiveVisionExample: '# ä¾‹: "èª°ã‚‚ãŒæ•™è‚²ã‚’å—ã‘ã‚‰ã‚Œã‚‹ä¸–ç•Œ"',
                visionRecorded: 'ãƒ“ã‚¸ãƒ§ãƒ³ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ',
                interactiveCommitPrompt: 'ã“ã®ãƒ“ã‚¸ãƒ§ãƒ³ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€ä»Šã™ãå–ã‚‹æœ€åˆã®å…·ä½“çš„ãªè¡Œå‹•ã¯ä½•ã§ã™ã‹ï¼Ÿ',
                interactiveCommitExample: '# ä¾‹: "ä»Šæ—¥ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ã‚¹ã«ç™»éŒ²ã™ã‚‹"',
                commitRecorded: 'æœ€åˆã®ã‚³ãƒŸãƒƒãƒˆã‚’è¨˜éŒ²ã—ã¾ã—ãŸ',
                interactiveConfirmPrompt: 'ã‚ãªãŸã®æœªæ¥ã‚’èµ·å‹•ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š',
                interactiveConfirm: 'å®Ÿè¡Œã™ã‚‹æº–å‚™ã¯ã§ãã¾ã—ãŸã‹ï¼Ÿã€Œyesã€ã§ç¶šè¡Œã€ã€Œnoã€ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã€‚',
                interactiveCancelled: 'å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚ã„ã¤ã§ã‚‚å†è©¦è¡Œã§ãã¾ã™ã€‚',
                executing: 'ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œä¸­...',
                initializing: 'æ–°ã—ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æœªæ¥ã‚’åˆæœŸåŒ–ä¸­...',
                visionLocked: 'ãƒ“ã‚¸ãƒ§ãƒ³',
                commitRegistered: 'æœ€åˆã®ã‚³ãƒŸãƒƒãƒˆ',
                bootComplete: 'ãƒ–ãƒ¼ãƒˆã‚·ãƒ¼ã‚±ãƒ³ã‚¹å®Œäº†ã€‚',
                processStarted: 'æœªæ¥ãƒ—ãƒ­ã‚»ã‚¹ãŒæ­£å¸¸ã«é–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚',
                daemonizing: 'ãƒ‡ãƒ¼ãƒ¢ãƒ³åŒ–ä¸­... ã‚ãªãŸã®æœªæ¥ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚³ãƒŸãƒƒãƒˆã—ç¶šã‘ã¦ãã ã•ã„ã€‚',
                generating: 'å…±æœ‰å¯èƒ½ãªã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ç”Ÿæˆä¸­...',
                shareText: 'ã‚ãªãŸã®æœªæ¥ãŒå§‹å‹•ã—ã¾ã—ãŸï¼ã“ã®ç¬é–“ã‚’å…±æœ‰ã—ã¾ã—ã‚‡ã†ã€‚',
                downloadButton: 'ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
                shareButton: 'Xã§å…±æœ‰',
                shareFacebook: 'Facebookã§å…±æœ‰',
                shareLinkedin: 'LinkedInã§å…±æœ‰',
                commandNotFound: 'ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
                helpUsage: 'ä½¿ç”¨æ–¹æ³•: ./future.sh --vision "<ãƒ“ã‚¸ãƒ§ãƒ³>" --commit "<ã‚¢ã‚¯ã‚·ãƒ§ãƒ³>"',
                helpDescription: 'ãƒ“ã‚¸ãƒ§ãƒ³ã‚’å®£è¨€ã—ã€è¡Œå‹•ã«ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã“ã¨ã§æœªæ¥ã‚’èµ·å‹•ã—ã¾ã™ã€‚',
                helpOptions: 'ã‚ªãƒ—ã‚·ãƒ§ãƒ³:',
                helpVision: '  --vision "<ãƒ†ã‚­ã‚¹ãƒˆ>"  ã‚ãªãŸã®æœªæ¥ã®ãƒ“ã‚¸ãƒ§ãƒ³ï¼ˆå¿…é ˆï¼‰',
                helpCommit: '  --commit "<ãƒ†ã‚­ã‚¹ãƒˆ>"  æœ€åˆã®å…·ä½“çš„ãªè¡Œå‹•ï¼ˆå¿…é ˆï¼‰',
                helpInteractive: '  --interactive         åˆå¿ƒè€…å‘ã‘ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ‰',
                helpHelp: '  --help                ã“ã®ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º',
                helpWhen: '  --when "<æ—¥ä»˜>"       é–‹å§‹æœŸé™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰',
                helpFirstStep: '  --first-step "<ãƒ†ã‚­ã‚¹ãƒˆ>" æœ€åˆã®å°ã•ãªè¡Œå‹•ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰',
                helpWhy: '  --why "<ãƒ†ã‚­ã‚¹ãƒˆ>"    å€‹äººçš„ãªå‹•æ©Ÿï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰',
                helpMilestone: '  --milestone "<ãƒ†ã‚­ã‚¹ãƒˆ>" ä¸­é–“ç›®æ¨™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰',
                helpExamples: 'ä¾‹:',
                helpExample1: '  ./future.sh --vision "ã‚¯ãƒªãƒ¼ãƒ³ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ä¸–ç•Œ" --commit "ã‚½ãƒ¼ãƒ©ãƒ¼ãƒ‘ãƒãƒ«ã‚’è¨­ç½®"',
                helpExample2: '  ./future.sh --interactive',
                helpExample3: '  ./future.sh --vision "ã©ã“ã§ã‚‚æ³³ã’ã‚‹ä¸–ç•Œã‚’ã¤ãã‚‹" --commit "éš£å®¶ã®åº­ã‚’æ˜ã‚‹" \\',
                helpExample4: '    --first-step "éš£å®¶ã«å¿ã³è¾¼ã‚€" --milestone "25ãƒ¡ãƒ¼ãƒˆãƒ«æ˜ã‚‹" \\',
                helpExample5: '    --why "éš£ã«ãƒ—ãƒ¼ãƒ«ãŒã‚ã‚‹ã®ã¯ç´ æ•µãªã“ã¨ã ã‹ã‚‰" --when "2025-07-07"',
                availableCommands: 'ä½¿ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:',
                cmdBootFuture: '  ./future.sh --vision "<ãƒ“ã‚¸ãƒ§ãƒ³>" --commit "<ã‚¢ã‚¯ã‚·ãƒ§ãƒ³>"  - æœªæ¥ã‚’èµ·å‹•',
                cmdInteractive: '  ./future.sh --interactive                            - ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ‰',
                cmdHelp: '  ./future.sh --help                                   - ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º',
                cmdLs: '  ls                                                        - ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§',
                cmdCat: '  cat <ãƒ•ã‚¡ã‚¤ãƒ«>                                              - ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹è¡¨ç¤º',
                cmdClear: '  clear                                                     - ç”»é¢ã‚¯ãƒªã‚¢',
                cmdPwd: '  pwd                                                       - ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª',
                cmdWhoami: '  whoami                                                    - ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼',
                cmdHelpCmd: '  help                                                      - ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º',
                firstCheckpoint: 'æœ€åˆã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ',
                milestone: 'ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³',
                drivenBy: 'å‹•æ©Ÿ',
                deadline: 'æœŸé™',
                sharePrompt: 'ã‚ãªãŸã®æœªæ¥ã‚’èª°ã‹ã¨å…±æœ‰ã—ã¾ã™ã‹ï¼Ÿ',
                shareYes: 'ã¯ã„',
                shareNo: 'ã„ã„ãˆ',
                shareDeclined: 'äº†è§£ã—ã¾ã—ãŸã€‚ã‚ãªãŸã®æœªæ¥ã¯ã™ã§ã«å‹•ãå§‹ã‚ã¦ã„ã¾ã™ã€‚\nã‚³ãƒŸãƒƒãƒˆã—ç¶šã‘ã¦ãã ã•ã„ï¼',
                shareTimeout: 'è‡ªå‹•é¸æŠ: ã„ã„ãˆï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰',
                shareLastNoData: 'å…±æœ‰ã™ã‚‹æœªæ¥ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãš ./future.sh ã§æœªæ¥ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ã€‚',
                shareLastPrompt: 'æœ€å¾Œã«èµ·å‹•ã—ãŸæœªæ¥ã‚’å…±æœ‰ã—ã¾ã™ã‹ï¼Ÿ',
                newUserHint: "åˆã‚ã¦ã§ã™ã‹ï¼Ÿ'ã‚¬ã‚¤ãƒ‰'ã¨å…¥åŠ›ã™ã‚‹ã¨åˆå¿ƒè€…å‘ã‘ãƒ¢ãƒ¼ãƒ‰ãŒå§‹ã¾ã‚Šã¾ã™ï¼",
                copyButton: 'ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼',
                copySuccess: 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼',
                copyFailed: 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»åƒã‚’ç›´æ¥å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚',
                copyTooltip: 'ç”»åƒã‚’ç›´æ¥å³ã‚¯ãƒªãƒƒã‚¯ã§ä¿å­˜ã§ãã¾ã™'
            }
        };
        
        // Detect if text contains Japanese characters
        function containsJapanese(text) {
            return /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(text);
        }
        
        // Get translation
        function t(key) {
            return i18n[currentLanguage][key] || i18n.en[key];
        }

        // [NEW] Define the error message lines as a constant for reuse
        function getErrorLines() {
            return [
                { text: `<span class="log-fatal">${t('fatal')}</span>` },
                { text: t('requiredFlags')},
                { text: '' },
                { text: t('usage')},
                { text: t('usageExample')},
                { text: '' },
                { text: `<span class="log-tip">${t('tip')}</span>`},
                { text: '' },
                { text: `<span class="log-info">ğŸ’¡ ${t('newUserHint')}</span>`}
            ];
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Detect user language at the very beginning
            currentLanguage = detectUserLanguage();
            
            // Save to localStorage for next time
            localStorage.setItem('preferredLanguage', currentLanguage);
            
            // Apply language to HTML element
            document.documentElement.lang = currentLanguage;
            
            terminal.addEventListener('click', () => {
                if (currentInput) {
                    currentInput.focus();
                }
            });
            runIntroAnimation();
        });

        // --- Helper Functions ---
        function addLine(text) {
            const line = document.createElement('div');
            line.className = 'line';
            line.innerHTML = text;
            terminal.appendChild(line);
            scrollToBottom();
            return line;
        }
        
        // Tab completion logic
        function handleTabCompletion(currentValue) {
            const parts = currentValue.split(' ');
            
            // Handle tab completion for cat command with files
            if (parts[0] === 'cat' && parts.length <= 2) {
                // If there's a space after cat, show files
                if (currentValue.includes(' ')) {
                    const partial = parts[1] || '';
                    
                    // Find matching files
                    const matches = availableFiles.filter(file => 
                        file.toLowerCase().startsWith(partial.toLowerCase())
                    );
                    
                    if (matches.length === 0) {
                        // No matches - do nothing
                        return { action: 'none' };
                    } else if (matches.length === 1) {
                        // Single match - auto-complete
                        return { 
                            action: 'complete',
                            value: `cat ${matches[0]}`
                        };
                    } else {
                        // Multiple matches - show options
                        return {
                            action: 'show-options',
                            options: matches
                        };
                    }
                }
            }
            
            // Handle tab completion for commands
            if (parts.length === 1 && !currentValue.includes(' ')) {
                const commands = ['cat', 'ls', 'clear', 'pwd', 'whoami', 'help', 'about', 'lang', 'future', './future', 'future.sh', './future.sh'];
                const partial = parts[0];
                
                const matches = commands.filter(cmd => 
                    cmd.toLowerCase().startsWith(partial.toLowerCase())
                );
                
                if (matches.length === 1) {
                    return { 
                        action: 'complete',
                        value: matches[0]
                    };
                } else if (matches.length > 1) {
                    return {
                        action: 'show-options',
                        options: matches
                    };
                }
            }
            
            return { action: 'none' };
        }
        
        // Display tab completion options
        function displayTabOptions(options) {
            addLine(options.join('   '));
        }
        
        // Attach input event listeners
        function attachInputListeners(input) {
            input.addEventListener('keydown', handleInputKeydown);
        }
        
        // Handle keydown events for input
        function handleInputKeydown(e) {
            const input = e.target;
            
            if (e.key === 'Enter') {
                // Don't process normal commands if interactive confirm prompt is active
                if (interactiveConfirmActive || sharePromptActive) {
                    return;
                }
                
                const command = input.value.trim();
                if (command) {
                    commandHistory.push(command);
                }
                const parent = input.parentElement;
                parent.innerHTML = `<span class="prompt">$</span><span>${escapeHtml(command)}</span>`;
                input.disabled = true;
                currentInput = null;
                processCommand(command, parent);
            } else if (e.key === 'Tab') {
                e.preventDefault();
                const result = handleTabCompletion(input.value);
                
                switch(result.action) {
                    case 'complete':
                        input.value = result.value;
                        input.setSelectionRange(input.value.length, input.value.length);
                        break;
                    case 'show-options':
                        // Save current line
                        const currentLine = input.parentElement;
                        currentLine.innerHTML = `<span class="prompt">$</span> ${escapeHtml(input.value)}`;
                        
                        // Show options
                        displayTabOptions(result.options);
                        
                        // Create new input line with preserved value
                        createInputLine();
                        currentInput.value = input.value;
                        currentInput.setSelectionRange(input.value.length, input.value.length);
                        break;
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    input.value = commandHistory[historyIndex];
                    input.setSelectionRange(input.value.length, input.value.length);
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    input.value = commandHistory[historyIndex];
                    input.setSelectionRange(input.value.length, input.value.length);
                } else {
                    historyIndex = commandHistory.length;
                    input.value = '';
                }
            }
        }

        function createInputLine() {
            const line = document.createElement('div');
            line.className = 'line command-input-container';
            line.innerHTML = `<span class="prompt">$</span><input type="text" class="terminal-input" autofocus>`;
            terminal.appendChild(line);
            
            currentInput = line.querySelector('.terminal-input');
            currentInput.focus();
            historyIndex = commandHistory.length;

            attachInputListeners(currentInput);
            scrollToBottom();
        }

        // --- Core Logic ---
        function processCommand(command, lineElement) {
            // Handle shell environment commands
            const parts = command.split(' ');
            const cmd = parts[0];
            
            // Handle shell commands
            if (cmd === 'ls') {
                addLine(availableFiles.join('   '));
                createInputLine();
                return;
            } else if (cmd === 'cat') {
                // Handle missing operand
                if (!parts[1]) {
                    addLine('cat: missing operand');
                    addLine('Try \'cat --help\' for more information.');
                    createInputLine();
                    return;
                }
                
                // Handle --help
                if (parts[1] === '--help') {
                    addLine('Usage: cat [FILE]...');
                    addLine('Concatenate FILE(s) to standard output.');
                    addLine('');
                    addLine('Examples:');
                    addLine('  cat README.md    Display contents of README.md');
                    addLine('  cat vision.txt   Display contents of vision.txt');
                    createInputLine();
                    return;
                }
                
                // Trim any extra spaces
                const filename = parts.slice(1).join(' ').trim();
                
                // Check if file exists
                if (fileSystem[filename]) {
                    const file = fileSystem[filename];
                    
                    // Handle protected files
                    if (file.protected) {
                        addLine(`<span class="log-fatal">cat: ${filename}: Permission denied (source is protected)</span>`);
                    } else if (file.content) {
                        // Display file content
                        file.content.forEach(line => addLine(line));
                    }
                } else {
                    addLine(`cat: ${filename}: No such file or directory`);
                }
                createInputLine();
                return;
            } else if (cmd === 'clear') {
                terminal.innerHTML = '';
                createInputLine();
                return;
            } else if (cmd === 'pwd') {
                addLine('/home/future/commits');
                createInputLine();
                return;
            } else if (cmd === 'whoami') {
                addLine('builder');
                createInputLine();
                return;
            } else if (cmd === 'help') {
                addLine(t('availableCommands'));
                addLine(t('cmdBootFuture'));
                addLine(t('cmdInteractive'));
                addLine(t('cmdHelp'));
                addLine(t('cmdLs'));
                addLine(t('cmdCat'));
                addLine(t('cmdClear'));
                addLine(t('cmdPwd'));
                addLine(t('cmdWhoami'));
                addLine(t('cmdHelpCmd'));
                addLine('  about                                                     - About this project');
                addLine('  lang [ja|en]                                              - Switch language');
                addLine('  share-last                                                - Share your last booted future');
                addLine(`  guide                                                     - ${currentLanguage === 'ja' ? 'åˆå¿ƒè€…å‘ã‘ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹' : 'Start beginner-friendly guided mode'}`);
                addLine('');
                addLine('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                addLine('the-future.sh v1.0');
                addLine('Created by Kaneko (<span class="log-info">@poknam</span>)');
                addLine('https://github.com/kanekop/the-future-sh');
                createInputLine();
                return;
            } else if (cmd === 'about') {
                addLine('the-future.sh - A tiny CLI simulator to boot your future');
                addLine('');
                addLine('Version: 1.0');
                addLine('');
                addLine('Created with â¤ï¸ by Kaneko');
                addLine('');
                addLine('ğŸ¦ X (Twitter): <span class="log-info">https://x.com/poknam</span>');
                addLine('ğŸ™ GitHub: <span class="log-info">https://github.com/kanekop</span>');
                addLine('ğŸ“¦ Project: <span class="log-info">https://github.com/kanekop/the-future-sh</span>');
                addLine('');
                addLine('<span class="log-tip">Remember: A vision without a commit is just a dream.</span>');
                createInputLine();
                return;
            } else if (cmd === 'lang') {
                if (parts[1] === 'ja' || parts[1] === 'en') {
                    currentLanguage = parts[1];
                    localStorage.setItem('preferredLanguage', currentLanguage);
                    document.documentElement.lang = currentLanguage;
                    addLine(`Language switched to ${parts[1] === 'ja' ? 'Japanese' : 'English'}`);
                    addLine('Reload the page to see the full effect.');
                } else {
                    addLine('Usage: lang [ja|en]');
                }
                createInputLine();
                return;
            } else if (cmd === 'share-last') {
                handleShareLastCommand();
                return;
            } else if (cmd === 'guide' || cmd === 'ã‚¬ã‚¤ãƒ‰') {
                consecutiveErrors = 0; // Reset error counter
                startInteractiveMode();
                return;
            }
            
            // Reset error counter for valid commands
            if (isValidCommand(command)) {
                consecutiveErrors = 0;
            }
            
            // Check for future.sh commands
            const futureRegex = /^(?:\.\/)?(?:future(?:\.sh)?)(.*)$/;
            const futureMatch = command.match(futureRegex);
            
            if (futureMatch) {
                const args = futureMatch[1].trim();
                
                // Handle --interactive flag
                if (args === '--interactive') {
                    startInteractiveMode();
                    return;
                }
                
                // Handle --help flag
                if (args === '--help') {
                    addLine(t('helpUsage'));
                    addLine('');
                    addLine(t('helpDescription'));
                    addLine('');
                    addLine(t('helpOptions'));
                    addLine(t('helpVision'));
                    addLine(t('helpCommit'));
                    addLine(t('helpWhen'));
                    addLine(t('helpFirstStep'));
                    addLine(t('helpWhy'));
                    addLine(t('helpMilestone'));
                    addLine(t('helpInteractive'));
                    addLine(t('helpHelp'));
                    addLine('');
                    addLine(t('helpExamples'));
                    addLine(t('helpExample1'));
                    addLine(t('helpExample2'));
                    addLine(t('helpExample3'));
                    addLine(t('helpExample4'));
                    addLine(t('helpExample5'));
                    createInputLine();
                    return;
                }
                
                // Check for vision and commit flags (required)
                const visionMatch = args.match(/--vision\s+["']([^"']+)["']/);
                const commitMatch = args.match(/--commit\s+["']([^"']+)["']/);
                
                if (visionMatch && commitMatch) {
                    consecutiveErrors = 0; // Reset on successful command
                    lineElement.classList.add('shareable-log');
                    const vision = visionMatch[1];
                    const commit = commitMatch[1];
                    
                    // Check for optional extended flags
                    const whenMatch = args.match(/--when\s+["']([^"']+)["']/);
                    const firstStepMatch = args.match(/--first-step\s+["']([^"']+)["']/);
                    const whyMatch = args.match(/--why\s+["']([^"']+)["']/);
                    const milestoneMatch = args.match(/--milestone\s+["']([^"']+)["']/);
                    
                    const extendedOptions = {
                        when: whenMatch ? whenMatch[1] : null,
                        firstStep: firstStepMatch ? firstStepMatch[1] : null,
                        why: whyMatch ? whyMatch[1] : null,
                        milestone: milestoneMatch ? milestoneMatch[1] : null
                    };
                    
                    
                    runSuccessSequence(vision, commit, false, extendedOptions);
                } else if (args === '') {
                    // Handle bare ./boot_future.sh
                    consecutiveErrors++;
                    runErrorSequence(() => {
                        setTimeout(createInputLine, 200);
                    });
                } else {
                    // Invalid arguments
                    consecutiveErrors++;
                    runErrorSequence(() => {
                        setTimeout(createInputLine, 200);
                    });
                }
            } else {
                // Command not found
                if (command) {
                    consecutiveErrors++;
                    addLine(`zsh: ${t('commandNotFound')}: ${escapeHtml(command.split(' ')[0])}`);
                }
                createInputLine();
            }
        }

        // --- Animation Sequences ---
        // Interactive mode functions
        function startInteractiveMode() {
            interactiveMode = true;
            interactiveStep = 'intro';
            
            addLine('');
            addLine(`<span class="log-info">${t('interactiveWelcome')}</span>`);
            addLine('');
            addLine(t('interactiveIntro'));
            addLine('');
            addLine(t('interactiveVisionPrompt'));
            addLine(`<span class="log-tip">${t('interactiveVisionExample')}</span>`);
            addLine('');
            
            createInteractiveInput();
        }
        
        function createInteractiveInput() {
            const line = document.createElement('div');
            line.className = 'line command-input-container';
            line.innerHTML = `<span class="prompt">></span><input type="text" class="terminal-input" autofocus>`;
            terminal.appendChild(line);
            
            currentInput = line.querySelector('.terminal-input');
            currentInput.focus();
            
            currentInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const value = currentInput.value.trim();
                    if (!value) return;
                    
                    const parent = currentInput.parentElement;
                    parent.innerHTML = `<span class="prompt">></span><span>${escapeHtml(value)}</span>`;
                    currentInput.disabled = true;
                    currentInput = null;
                    
                    handleInteractiveInput(value);
                }
            });
            scrollToBottom();
        }
        
        function handleInteractiveInput(value) {
            if (interactiveStep === 'intro') {
                interactiveVision = value;
                interactiveStep = 'commit';
                
                addLine('');
                addLine(`<span class="log-ok">[ OK ]</span> ${t('visionRecorded')}: "${escapeHtml(value)}"`);
                addLine('');
                addLine(t('interactiveCommitPrompt'));
                addLine(`<span class="log-tip">${t('interactiveCommitExample')}</span>`);
                addLine('');
                
                createInteractiveInput();
            } else if (interactiveStep === 'commit') {
                interactiveCommit = value;
                interactiveStep = 'confirm';
                
                addLine('');
                addLine(`<span class="log-ok">[ OK ]</span> ${t('commitRecorded')}: "${escapeHtml(value)}"`);
                addLine('');
                addLine(t('interactiveConfirmPrompt'));
                addLine('');
                addLine(`<span class="log-info">$</span> ./future.sh --vision "${escapeHtml(interactiveVision)}" --commit "${escapeHtml(interactiveCommit)}"`);
                addLine('');
                addLine(t('interactiveConfirm'));
                
                // Make sure no input is active
                if (currentInput) {
                    currentInput.disabled = true;
                    currentInput = null;
                }
                
                // Show the interactive confirm prompt instead of text input
                showInteractiveConfirmPrompt();
            }
        }
        
        // [NEW] A dedicated function to display the error message sequence
        function runErrorSequence(onComplete) {
            let delay = 0;
            const errorLines = getErrorLines();
            errorLines.forEach((line, index) => {
                setTimeout(() => {
                    const lineElement = addLine(line.text);
                    if (index === errorLines.length - 1 && onComplete) {
                        onComplete();
                    }
                }, delay);
                delay += 100;
            });
        }

        function runIntroAnimation() {
            // Disable user interaction during animation
            terminal.style.pointerEvents = 'none';
            
            let animationActive = true;
            let timeouts = [];
            
            // Allow ESC key to skip animation
            function handleEscKey(e) {
                if (e.key === 'Escape' && animationActive) {
                    animationActive = false;
                    timeouts.forEach(timeout => clearTimeout(timeout));
                    document.removeEventListener('keydown', handleEscKey);
                    terminal.innerHTML = '';
                    terminal.style.pointerEvents = 'auto';
                    
                    // Show the final state immediately
                    const skipLine = addLine('$ ./future.sh');
                    commandHistory.push('./future.sh');
                    runErrorSequence(() => {
                        createInputLine();
                    });
                }
            }
            document.addEventListener('keydown', handleEscKey);
            
            // Step 1: Show initial prompt with cursor (0ms)
            const introLine = document.createElement('div');
            introLine.className = 'line intro-line';
            introLine.innerHTML = '<span class="prompt">$</span> <span class="typing-text"></span><span class="typing-cursor"></span>';
            terminal.appendChild(introLine);
            
            const typingText = introLine.querySelector('.typing-text');
            const typingCursor = introLine.querySelector('.typing-cursor');
            
            // Step 2: Auto-typing phase (500ms - 1900ms)
            const command = './future.sh';
            let charIndex = 0;
            
            function typeNextChar() {
                if (!animationActive) return;
                
                if (charIndex < command.length) {
                    typingText.textContent += command[charIndex];
                    charIndex++;
                    
                    // Vary typing speed: slower for "./boot_", faster for "future.sh"
                    const delay = charIndex <= 7 ? 50 : 30;
                    timeouts.push(setTimeout(typeNextChar, delay));
                } else {
                    // Step 2.5: Cursor blinks to show hesitation (1400ms - 1900ms)
                    timeouts.push(setTimeout(simulateEnterPress, 500));
                }
            }
            
            // Start typing after initial delay
            timeouts.push(setTimeout(typeNextChar, 500));
            
            function simulateEnterPress() {
                if (!animationActive) return;
                
                // Step 3: Enter key animation (1900ms - 2000ms)
                // Remove cursor and convert to executed command
                typingCursor.remove();
                introLine.innerHTML = `<span class="prompt">$</span> ${escapeHtml(command)}`;
                introLine.classList.remove('intro-line');
                introLine.classList.add('command-execute');
                
                // Add to command history
                commandHistory.push(command);
                
                // Step 4: Error sequence display (2000ms - 3000ms)
                timeouts.push(setTimeout(() => {
                    if (!animationActive) return;
                    
                    runErrorSequence(() => {
                        // Step 5: Ready state (3000ms+)
                        animationActive = false;
                        document.removeEventListener('keydown', handleEscKey);
                        terminal.style.pointerEvents = 'auto';
                        createInputLine();
                    });
                }, 100));
            }
        }

        function runSuccessSequence(vision, commit, isTrainingMode = false, extendedOptions = {}) {
            const successLines = [
                { text: t('initializing') },
                { text: `<span class="log-info">[INFO]</span> ${t('visionLocked')}: "${escapeHtml(vision)}"` },
                { text: `<span class="log-info">[INFO]</span> ${t('commitRegistered')}: "${escapeHtml(commit)}"` },
                { text: `<span class="log-ok">[ OK ]</span> ${t('bootComplete')}` },
                { text: `` }
            ];
            
            // Generate PID and base message
            const pid = `${new Date().getFullYear()}${(new Date().getMonth() + 1).toString().padStart(2, '0')}${(new Date().getDate()).toString().padStart(2, '0')}`;
            
            // Check if we have extended options
            const hasExtendedOptions = extendedOptions.when || extendedOptions.firstStep || 
                                     extendedOptions.why || extendedOptions.milestone;
            
            if (hasExtendedOptions) {
                // Rich output format with tree structure
                successLines.push({ text: `${t('processStarted')} (PID: ${pid})` });
                
                if (extendedOptions.firstStep) {
                    successLines.push({ text: `â”œâ”€â”€ ${t('firstCheckpoint')}: ${escapeHtml(extendedOptions.firstStep)}` });
                }
                if (extendedOptions.milestone) {
                    successLines.push({ text: `â”œâ”€â”€ ${t('milestone')}: ${escapeHtml(extendedOptions.milestone)}` });
                }
                if (extendedOptions.why) {
                    successLines.push({ text: `â”œâ”€â”€ ${t('drivenBy')}: ${escapeHtml(extendedOptions.why)}` });
                }
                if (extendedOptions.when) {
                    successLines.push({ text: `â””â”€â”€ ${t('deadline')}: ${escapeHtml(extendedOptions.when)}` });
                }
            } else {
                // Simple output format
                successLines.push({ text: `${t('processStarted')} (PID: ${pid})` });
            }
            
            successLines.push({ text: t('daemonizing') });

            let delay = 0;
            successLines.forEach((line, index) => {
                setTimeout(() => {
                    const lineElement = addLine(line.text);
                    lineElement.classList.add('shareable-log');

                    if (index === successLines.length - 1) {
                        // Store the boot data for potential later sharing
                        storeLastBootedFuture(vision, commit, isTrainingMode, extendedOptions);
                        
                        // Show generating message and then share prompt
                        setTimeout(() => {
                            const generatingLine = addLine(t('generating'));
                            generatingLine.classList.add('shareable-log');
                            setTimeout(() => showSharePrompt(), 500);
                        }, 500);
                    }
                }, delay);
                delay += (line.text.length * 15) + 100;
            });
        }
        
        // --- Shareable Image Generation ---
        function generateShareableImage(vision, commit, isTrainingMode = false, extendedOptions = {}) {
            // Note: "Generating snapshot" message is now shown before the share prompt
            
            setTimeout(() => {
                const snapshotContainer = document.createElement('div');
                snapshotContainer.style.position = 'absolute';
                snapshotContainer.style.left = '-9999px';
                snapshotContainer.style.display = 'inline-block';
                snapshotContainer.style.padding = '20px';
                snapshotContainer.style.boxSizing = 'border-box';
                snapshotContainer.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--background-color');
                snapshotContainer.style.fontFamily = getComputedStyle(document.documentElement).getPropertyValue('--font-family');
                snapshotContainer.style.fontSize = '16px';
                snapshotContainer.style.lineHeight = '1.6';
                snapshotContainer.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');

                const linesToShare = document.querySelectorAll('.shareable-log');
                linesToShare.forEach(line => {
                    snapshotContainer.appendChild(line.cloneNode(true));
                });

                document.body.appendChild(snapshotContainer);

                html2canvas(snapshotContainer, { logging: false, backgroundColor: null }).then(canvas => {
                    // Add training mode watermark if needed
                    if (isTrainingMode) {
                        const ctx = canvas.getContext('2d');
                        ctx.save();
                        ctx.font = 'bold 48px ' + getComputedStyle(document.documentElement).getPropertyValue('--font-family');
                        ctx.fillStyle = 'rgba(88, 166, 255, 0.3)';
                        ctx.textAlign = 'center';
                        ctx.translate(canvas.width / 2, canvas.height / 2);
                        ctx.rotate(-Math.PI / 6);
                        ctx.fillText('TRAINING MODE', 0, 0);
                        ctx.restore();
                    }
                    
                    const imageUrl = canvas.toDataURL('image/png');
                    document.body.removeChild(snapshotContainer);

                    headerContainer.innerHTML = '';

                    const shareContainer = document.createElement('div');
                    shareContainer.id = 'share-container';
                    
                    const shareText = currentLanguage === 'ja' 
                        ? `æ€ã„æãæœªæ¥ï¼š\n\nãƒ“ã‚¸ãƒ§ãƒ³: ${vision}\nã‚³ãƒŸãƒƒãƒˆ: ${commit}\n\nè‡ªåˆ†ã®æœªæ¥ã‚’æ€ã„æã“ã†: ${window.location.href}\n#BootYourFuture`
                        : `My envisioned future:\n\nVision: ${vision}\nCommit: ${commit}\n\nEnvision your own future at ${window.location.href}\n#BootYourFuture`;
                    
                    // Social media share URLs
                    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
                    
                    // Facebook share (URL only, Facebook will fetch Open Graph data)
                    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(shareText)}`;
                    
                    // LinkedIn share
                    const linkedinTitle = currentLanguage === 'ja' ? 'æ€ã„æãæœªæ¥ï¼š' : "My envisioned future:";
                    const linkedinSummary = currentLanguage === 'ja' 
                        ? `ãƒ“ã‚¸ãƒ§ãƒ³: ${vision}\nã‚³ãƒŸãƒƒãƒˆ: ${commit}`
                        : `Vision: ${vision}\nCommit: ${commit}`;
                    const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}&title=${encodeURIComponent(linkedinTitle)}&summary=${encodeURIComponent(linkedinSummary)}`;

                    // Check for Clipboard API support
                    const supportsClipboard = navigator.clipboard && window.ClipboardItem;
                    
                    if (supportsClipboard) {
                        shareContainer.innerHTML = `
                            <p>${t('shareText')}</p>
                            <div class="share-buttons">
                                <button id="copyButton" class="share-button" title="${t('copyTooltip')}">ğŸ“‹ ${t('copyButton')}</button>
                                <a href="${twitterUrl}" target="_blank" class="share-button share-twitter">${t('shareButton')}</a>
                                <a href="${facebookUrl}" target="_blank" class="share-button share-facebook">${t('shareFacebook')}</a>
                                <a href="${linkedinUrl}" target="_blank" class="share-button share-linkedin">${t('shareLinkedin')}</a>
                            </div>
                            <img src="${imageUrl}" alt="A snapshot of the initiated future in the-future.sh">
                        `;
                    } else {
                        // Fallback to download button
                        shareContainer.innerHTML = `
                            <p>${t('shareText')}</p>
                            <div class="share-buttons">
                                <a href="${imageUrl}" download="the-future-sh.png" class="share-button">${t('downloadButton')}</a>
                                <a href="${twitterUrl}" target="_blank" class="share-button share-twitter">${t('shareButton')}</a>
                                <a href="${facebookUrl}" target="_blank" class="share-button share-facebook">${t('shareFacebook')}</a>
                                <a href="${linkedinUrl}" target="_blank" class="share-button share-linkedin">${t('shareLinkedin')}</a>
                            </div>
                            <img src="${imageUrl}" alt="A snapshot of the initiated future in the-future.sh">
                        `;
                    }
                    
                    headerContainer.appendChild(shareContainer);
                    shareContainer.style.display = 'block';
                    
                    // Add copy button event listener if supported
                    if (supportsClipboard) {
                        const copyButton = document.getElementById('copyButton');
                        copyButton.addEventListener('click', async () => {
                            const success = await copyImageToClipboard(canvas);
                            showCopyFeedback(copyButton, success);
                        });
                    }
                    
                    window.scrollTo(0, 0);
                });
            }, 100);
        }

        // --- Share Prompt Functions ---
        function showSharePrompt() {
            sharePromptActive = true;
            sharePromptSelection = 1;
            
            // Add empty line
            addLine('');
            
            // Add prompt question
            const promptLine = addLine(t('sharePrompt'));
            promptLine.classList.add('share-prompt');
            
            // Add options
            const option1 = addLine(`  1. ${t('shareYes')}`);
            option1.classList.add('share-option');
            option1.id = 'share-option-1';
            
            const option2 = addLine(`  2. ${t('shareNo')}`);
            option2.classList.add('share-option');
            option2.id = 'share-option-2';
            
            // Update display to show initial selection
            updateSharePromptDisplay();
            
            // Add keyboard event listener
            document.addEventListener('keydown', handleSharePromptKeydown);
            
            // Set timeout for auto-selection
            shareTimeoutId = setTimeout(() => {
                if (sharePromptActive) {
                    addLine('');
                    addLine(`<span style="color: #7f8c8d;">${t('shareTimeout')}</span>`);
                    executeShareChoice(2); // Auto-select "No"
                }
            }, 180000); // 3 minutes
        }
        
        function handleSharePromptKeydown(e) {
            if (!sharePromptActive) return;
            
            e.preventDefault();
            
            // Arrow keys
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                sharePromptSelection = sharePromptSelection === 1 ? 2 : 1;
                updateSharePromptDisplay();
                return;
            }
            
            // Enter key
            if (e.key === 'Enter') {
                executeShareChoice(sharePromptSelection);
                return;
            }
            
            // Number keys
            if (e.key === '1') {
                sharePromptSelection = 1;
                updateSharePromptDisplay();
                setTimeout(() => executeShareChoice(1), 100);
                return;
            }
            
            if (e.key === '2') {
                sharePromptSelection = 2;
                updateSharePromptDisplay();
                setTimeout(() => executeShareChoice(2), 100);
                return;
            }
            
            // Y/N shortcuts
            if (e.key.toLowerCase() === 'y') {
                sharePromptSelection = 1;
                updateSharePromptDisplay();
                setTimeout(() => executeShareChoice(1), 100);
                return;
            }
            
            if (e.key.toLowerCase() === 'n') {
                sharePromptSelection = 2;
                updateSharePromptDisplay();
                setTimeout(() => executeShareChoice(2), 100);
                return;
            }
        }
        
        function updateSharePromptDisplay() {
            const option1 = document.getElementById('share-option-1');
            const option2 = document.getElementById('share-option-2');
            
            if (option1 && option2) {
                option1.classList.toggle('selected', sharePromptSelection === 1);
                option2.classList.toggle('selected', sharePromptSelection === 2);
            }
        }
        
        function executeShareChoice(choice) {
            // Clear timeout
            if (shareTimeoutId) {
                clearTimeout(shareTimeoutId);
                shareTimeoutId = null;
            }
            
            // Remove event listener
            document.removeEventListener('keydown', handleSharePromptKeydown);
            sharePromptActive = false;
            
            if (choice === 1) {
                // User chose to share
                // The generateShareableImage function will be called to show the share container
                if (lastBootedFuture) {
                    generateShareableImage(
                        lastBootedFuture.vision,
                        lastBootedFuture.commit,
                        lastBootedFuture.isTrainingMode,
                        lastBootedFuture.extendedOptions
                    );
                }
            } else {
                // User chose not to share
                addLine('');
                const declineMessage = t('shareDeclined');
                declineMessage.split('\n').forEach(line => {
                    addLine(line);
                });
                setTimeout(createInputLine, 500);
            }
        }
        
        function storeLastBootedFuture(vision, commit, isTrainingMode, extendedOptions) {
            lastBootedFuture = {
                vision,
                commit,
                isTrainingMode,
                extendedOptions,
                timestamp: new Date().toISOString()
            };
        }
        
        function handleShareLastCommand() {
            if (!lastBootedFuture) {
                addLine(t('shareLastNoData'));
                createInputLine();
                return;
            }
            
            // Show the share prompt for the last booted future
            addLine(t('shareLastPrompt'));
            showSharePrompt();
        }
        
        // --- Interactive Confirm Prompt Functions ---
        function showInteractiveConfirmPrompt() {
            interactiveConfirmActive = true;
            interactiveConfirmSelection = 1;
            
            // Add options
            const option1 = addLine(`  1. ${t('shareYes')}`);
            option1.classList.add('share-option');
            option1.id = 'interactive-confirm-option-1';
            
            const option2 = addLine(`  2. ${t('shareNo')}`);
            option2.classList.add('share-option');
            option2.id = 'interactive-confirm-option-2';
            
            // Update display to show initial selection
            updateInteractiveConfirmDisplay();
            
            // Add keyboard event listener with capture to ensure it's processed first
            document.addEventListener('keydown', handleInteractiveConfirmKeydown, true);
        }
        
        function handleInteractiveConfirmKeydown(e) {
            if (!interactiveConfirmActive) return;
            
            // Arrow keys
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                e.preventDefault();
                interactiveConfirmSelection = interactiveConfirmSelection === 1 ? 2 : 1;
                updateInteractiveConfirmDisplay();
                return;
            }
            
            // Enter key
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                executeInteractiveConfirmChoice(interactiveConfirmSelection);
                return;
            }
            
            // Number keys
            if (e.key === '1') {
                e.preventDefault();
                interactiveConfirmSelection = 1;
                updateInteractiveConfirmDisplay();
                setTimeout(() => executeInteractiveConfirmChoice(1), 100);
                return;
            }
            
            if (e.key === '2') {
                e.preventDefault();
                interactiveConfirmSelection = 2;
                updateInteractiveConfirmDisplay();
                setTimeout(() => executeInteractiveConfirmChoice(2), 100);
                return;
            }
            
            // Y/N shortcuts
            if (e.key.toLowerCase() === 'y') {
                e.preventDefault();
                interactiveConfirmSelection = 1;
                updateInteractiveConfirmDisplay();
                setTimeout(() => executeInteractiveConfirmChoice(1), 100);
                return;
            }
            
            if (e.key.toLowerCase() === 'n') {
                e.preventDefault();
                interactiveConfirmSelection = 2;
                updateInteractiveConfirmDisplay();
                setTimeout(() => executeInteractiveConfirmChoice(2), 100);
                return;
            }
        }
        
        function updateInteractiveConfirmDisplay() {
            const option1 = document.getElementById('interactive-confirm-option-1');
            const option2 = document.getElementById('interactive-confirm-option-2');
            
            if (option1 && option2) {
                option1.classList.toggle('selected', interactiveConfirmSelection === 1);
                option2.classList.toggle('selected', interactiveConfirmSelection === 2);
            }
        }
        
        function executeInteractiveConfirmChoice(choice) {
            // Remove event listener (with capture flag to match how it was added)
            document.removeEventListener('keydown', handleInteractiveConfirmKeydown, true);
            interactiveConfirmActive = false;
            
            if (choice === 1) {
                // User chose Yes
                interactiveMode = false;
                
                addLine('');
                addLine(t('executing'));
                addLine('');
                
                // Mark the command line as shareable
                const cmdLine = addLine(`$ ./future.sh --vision "${escapeHtml(interactiveVision)}" --commit "${escapeHtml(interactiveCommit)}"`);
                cmdLine.classList.add('shareable-log');
                
                runSuccessSequence(interactiveVision, interactiveCommit, true); // true indicates training mode
            } else {
                // User chose No
                interactiveMode = false;
                addLine('');
                addLine(t('interactiveCancelled'));
                createInputLine();
            }
        }
        
        // --- Helper Functions ---
        function isValidCommand(command) {
            const cmd = command.split(' ')[0];
            const validCommands = [
                'ls', 'cat', 'clear', 'pwd', 'whoami', 'help', 'about', 'lang', 
                'share-last', 'guide', 'ã‚¬ã‚¤ãƒ‰',
                'future', './future', 'future.sh', './future.sh'
            ];
            return validCommands.includes(cmd);
        }
        
        function showGuideHint() {
            addLine('');  // Empty line for separation
            addLine(`<span class="log-info">ğŸ’¡ ${t('newUserHint')}</span>`);
        }
        
        // Copy image to clipboard function
        async function copyImageToClipboard(canvas) {
            try {
                // Convert canvas to blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                
                // Check if Clipboard API is available
                if (!navigator.clipboard || !window.ClipboardItem) {
                    throw new Error('Clipboard API not supported');
                }
                
                // Write to clipboard
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'image/png': blob
                    })
                ]);
                
                return true;
            } catch (err) {
                console.error('Failed to copy image:', err);
                return false;
            }
        }
        
        // Show copy feedback
        function showCopyFeedback(button, success) {
            const originalText = button.textContent;
            const originalBg = button.style.backgroundColor;
            
            if (success) {
                button.textContent = `âœ“ ${t('copySuccess')}`;
                button.style.backgroundColor = '#28a745';
            } else {
                button.textContent = t('copyFailed');
                button.style.backgroundColor = '#dc3545';
            }
            
            // Reset after 2 seconds
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = originalBg;
            }, 2000);
        }
        
        // --- Utility Functions ---
        function scrollToBottom() {
            terminal.scrollTop = terminal.scrollHeight;
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
